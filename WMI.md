# WMI (Windows Management Instrumentation)

## What is WMI?

https://msdn.microsoft.com/en-us/library/aa394582(v=vs.85).aspx

> Windows Management Instrumentation (WMI) is the infrastructure for management data and operations on Windows-based operating systems. You can write WMI scripts or applications to automate administrative tasks on remote computers but WMI also supplies management data to other parts of the operating system and products, for example System Center Operations Manager, formerly Microsoft Operations Manager (MOM), or Windows Remote Management ([WinRM](https://msdn.microsoft.com/en-us/library/aa384426(v=vs.85).aspx)).
>
> WMI can be used in all Windows-based applications, and is most useful in enterprise applications and administrative scripts.

https://www.darkoperator.com/blog/2013/1/31/introduction-to-wmi-basics-with-powershell-part-1-what-it-is.html

> We can look at WMI as a collection of **objects** that provide access to different parts of the operating system.
>
> Each of these objects are defined by what is called **MOF**  (Manage Object Format) files that are saved in **%windir%\System32\wbem** with the extension of .mof. The MOF files get loaded by what is called a **Provider**, when the Provider is registered he loads the definitions of the objects in to the current WMI **Namespace**. The Namespace can be seen a file system structure that organizes the objects on function, inside of each namespace the objects are just like in PowerShell in what is called Class Instances and each of this is populated with the OS and Application information as the system runs so we always have the **latest** information in this classes.

可以把WMI作为一系列对象（object）的集合，通过这些对象可以访问操作系统的不同部分。每个对象由相应的.mof文件定义，然后由提供者（Provider）加载，当这个提供者被注册时，它会将对象的定义加载到WMI的命名空间（Namespace）中，每次从WMI获取到的信息都是实时的。

可以用[WMI Explorer](https://www.sapien.com/software/wmiexplorer)来查看对象：

![wmi-explorer](./images/wmi-explorer.png)

## WMI Script

Windows官方支持使用PowerShell和VBScript来访问WMI

> Many administrators and IT professionals access WMI through PowerShell. The **`Get-WMI`** cmdlet for PowerShell enables you to retrieve information for a local or remote WMI **repository**. As such, a number of topics and classes, especially in the [Creating WMI Clients](https://msdn.microsoft.com/en-us/library/cc512236(v=vs.85).aspx) section, contain PowerShell examples. For additional information on using PowerShell, see [Windows PowerShell](https://msdn.microsoft.com/en-us/library/dd835506(v=vs.85).aspx)and [Scripting with Windows PowerShell](https://technet.microsoft.com/en-us/library/bb978526.aspx).

example：

```powershell
Get-Wmiobject -NameSpace root\ServiceModel -Class ClientCredentials
```

## WMI Exec Command

https://threathunter.org/topic/5940a6e59c58e020408a79ea

- `wmic`：windows内置WMI命令行，缺点是默认情况下无法得到执行命令的回显。eg：`wmic /node:192.168.38.137 /user:administrator /password:123456 process call create cmd.exe`
- [impacket](https://github.com/CoreSecurity/impacket)中的wmiexec.py，有回显，可在Linux下执行。eg：`wmiexec.py administrator:pass@192.168.38.137`
- PowerSploit中的[Invoke-WmiCommand.ps1](http://powersploit.readthedocs.io/en/latest/CodeExecution/Invoke-WmiCommand/)，需要powershell环境。

## Reference

https://msdn.microsoft.com/en-us/library/aa394582(v=vs.85).aspx

https://www.darkoperator.com/blog/2013/1/31/introduction-to-wmi-basics-with-powershell-part-1-what-it-is.html

https://threathunter.org/topic/5940a6e59c58e020408a79ea